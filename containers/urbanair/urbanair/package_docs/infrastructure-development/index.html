
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="Documentation for the UrbanAir project" name="description"/>
<link href="https://urbanair.turing.ac.uk/docs/infrastructure-development/" rel="canonical"/>
<meta content="Oscar Giles etc" name="author"/>
<link href="../assets/images/favicon.png" rel="shortcut icon"/>
<meta content="mkdocs-1.1.2, mkdocs-material-5.3.0" name="generator"/>
<title>Infrastructure Deployment - Urbanair</title>
<link href="../assets/stylesheets/main.6e35a1a6.min.css" rel="stylesheet"/>
<link href="../assets/stylesheets/palette.a46bcfb3.min.css" rel="stylesheet"/>
<meta content="#3f51b5" name="theme-color"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&amp;display=fallback" rel="stylesheet"/>
<style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-XXXXXXXX-X","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}),document.addEventListener("DOMContentSwitch",function(){ga("send","pageview")})</script>
<script async="" src="https://www.google-analytics.com/analytics.js"></script>
</head>
<body data-md-color-accent="indigo" data-md-color-primary="indigo" data-md-color-scheme="" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#infrastructure-deployment">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="Header" class="md-header-nav md-grid">
<a aria-label="Urbanair" class="md-header-nav__button md-logo" href="https://urbanair.turing.ac.uk/docs" title="Urbanair">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"></path></svg>
</a>
<label class="md-header-nav__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"></path></svg>
</label>
<div class="md-header-nav__title" data-md-component="header-title">
<div class="md-header-nav__ellipsis">
<span class="md-header-nav__topic md-ellipsis">
            Urbanair
          </span>
<span class="md-header-nav__topic md-ellipsis">
            
              Infrastructure Deployment
            
          </span>
</div>
</div>
<label class="md-header-nav__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" data-md-state="active" name="query" placeholder="Search" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</label>
<button aria-label="Clear" class="md-search__icon md-icon" data-md-component="search-reset" tabindex="-1" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"></path></svg>
</button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header-nav__source">
<a class="md-source" href="https://github.com/alan-turing-institute/clean-air-infrastructure/" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"></path></svg>
</div>
<div class="md-source__repository">
    alan-turing-institute/clean-air-infrastructure
  </div>
</a>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="Urbanair" class="md-nav__button md-logo" href="https://urbanair.turing.ac.uk/docs" title="Urbanair">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"></path></svg>
</a>
    Urbanair
  </label>
<div class="md-nav__source">
<a class="md-source" href="https://github.com/alan-turing-institute/clean-air-infrastructure/" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"></path></svg>
</div>
<div class="md-source__repository">
    alan-turing-institute/clean-air-infrastructure
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href=".." title="Cleanair">
      Cleanair
    </a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" data-md-toggle="nav-2" id="nav-2" type="checkbox"/>
<label class="md-nav__link" for="nav-2">
      User Guide
      <span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"></path></svg>
</span>
</label>
<nav aria-label="User Guide" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="nav-2">
<span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</span>
        User Guide
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="nav-2-1" id="nav-2-1" type="checkbox"/>
<label class="md-nav__link" for="nav-2-1">
      Setting up a developmet environment
      <span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"></path></svg>
</span>
</label>
<nav aria-label="Setting up a developmet environment" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="nav-2-1">
<span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</span>
        Setting up a developmet environment
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../setup/azure-account/" title="Azure account">
      Azure account
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../setup/non-infrastructure-dependencies/" title="Non-infrastructure dependencies">
      Non-infrastructure dependencies
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../setup/infrastructure-dependencies/" title="Infrastructure dependencies">
      Infrastructure dependencies
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../setup/configure-local-database/" title="Configure a local database">
      Configure a local database
    </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../accessing-production-database/" title="Access CleanAir Production Database">
      Access CleanAir Production Database
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../entry-points/" title="Entry points">
      Entry points
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../urbanair-api/" title="UrbanAir API">
      UrbanAir API
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../developer-guide/" title="Developer guide">
      Developer guide
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../researcher-guide/" title="Researcher guide">
      Researcher guide
    </a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" data-md-toggle="toc" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
        Infrastructure Deployment
        <span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 9h14V7H3v2m0 4h14v-2H3v2m0 4h14v-2H3v2m16 0h2v-2h-2v2m0-10v2h2V7h-2m0 6h2v-2h-2v2z"></path></svg>
</span>
</label>
<a class="md-nav__link md-nav__link--active" href="./" title="Infrastructure Deployment">
      Infrastructure Deployment
    </a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#login-to-travis-cli">
    Login to Travis CLI
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#setup-terraform-with-python">
    Setup Terraform with Python
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#building-the-clean-air-infrastructure-with-terraform">
    Building the Clean Air infrastructure with Terraform
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#creating-a-record-for-cleanair-api-do-this-before-running-azure-pipelines">
    Creating A Record for cleanair API (DO THIS BEFORE RUNNING AZURE PIPELINES)
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#initialising-the-input-databases">
    Initialising the input databases
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#setting-up-azure-pipelines">
    Setting up Azure pipelines
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#add-static-datasets">
    Add static datasets
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#adding-live-datasets">
    Adding live datasets
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#kubernetes-deployment-with-gpu-support">
    Kubernetes deployment with GPU support
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#removing-terraform-infrastructure">
    Removing Terraform infrastructure
  </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" id="nav-3" type="checkbox"/>
<label class="md-nav__link" for="nav-3">
      API
      <span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"></path></svg>
</span>
</label>
<nav aria-label="API" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="nav-3">
<span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</span>
        API
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-1" id="nav-3-1" type="checkbox"/>
<label class="md-nav__link" for="nav-3-1">
      Cleanair
      <span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"></path></svg>
</span>
</label>
<nav aria-label="Cleanair" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="nav-3-1">
<span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</span>
        Cleanair
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../API/cleanair/dashboard/" title="Dashboard">
      Dashboard
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../API/cleanair/databases/" title="Databases">
      Databases
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../API/cleanair/decorators/" title="Decorators">
      Decorators
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../API/cleanair/features/" title="Features">
      Features
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../API/cleanair/inputs/" title="Inputs">
      Inputs
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../API/cleanair/instance/" title="Instance">
      Instance
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../API/cleanair/loggers/" title="Loggers">
      Loggers
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../API/cleanair/metrics/" title="Metrics">
      Metrics
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../API/cleanair/mixins/" title="Mixins">
      Mixins
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../API/cleanair/models/" title="Models">
      Models
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../API/cleanair/parsers/" title="Parsers">
      Parsers
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../API/cleanair/timestamps/" title="Timestamps">
      Timestamps
    </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-2" id="nav-3-2" type="checkbox"/>
<label class="md-nav__link" for="nav-3-2">
      Odysseus
      <span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"></path></svg>
</span>
</label>
<nav aria-label="Odysseus" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="nav-3-2">
<span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</span>
        Odysseus
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../API/odysseus/databases/" title="Databases">
      Databases
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../API/odysseus/test_types/" title="Test Types">
      Test Types
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../API/odysseus/dates/" title="Dates">
      Dates
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../API/odysseus/metric/" title="Metric">
      Metric
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../API/odysseus/parsers/" title="Parsers">
      Parsers
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../API/odysseus/preprocess/" title="Preprocess">
      Preprocess
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../API/odysseus/scoot_processing/" title="Scoot_processing">
      Scoot_processing
    </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#login-to-travis-cli">
    Login to Travis CLI
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#setup-terraform-with-python">
    Setup Terraform with Python
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#building-the-clean-air-infrastructure-with-terraform">
    Building the Clean Air infrastructure with Terraform
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#creating-a-record-for-cleanair-api-do-this-before-running-azure-pipelines">
    Creating A Record for cleanair API (DO THIS BEFORE RUNNING AZURE PIPELINES)
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#initialising-the-input-databases">
    Initialising the input databases
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#setting-up-azure-pipelines">
    Setting up Azure pipelines
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#add-static-datasets">
    Add static datasets
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#adding-live-datasets">
    Adding live datasets
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#kubernetes-deployment-with-gpu-support">
    Kubernetes deployment with GPU support
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#removing-terraform-infrastructure">
    Removing Terraform infrastructure
  </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<a class="md-content__button md-icon" href="https://github.com/alan-turing-institute/clean-air-infrastructure/edit/master/docs/infrastructure-development.md" title="Edit this page">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"></path></svg>
</a>
<h1 id="infrastructure-deployment">Infrastructure Deployment<a class="headerlink" href="#infrastructure-deployment" title="Permanent link">¶</a></h1>
<p><strong>The following steps are needed to setup the Clean Air cloud infrastructure. Only infrastrucure administrator should deploy</strong></p>
<h2 id="login-to-travis-cli">Login to Travis CLI<a class="headerlink" href="#login-to-travis-cli" title="Permanent link">¶</a></h2>
<p>Login to Travis with your github credentials, making sure you are in the Clean Air repository (Travis automatically detects your repository):</p>
<div class="codehilite"><pre><span></span><code>travis login --pro
</code></pre></div>
<p>Create an Azure service principal using the documentation for the <a href="https://docs.microsoft.com/en-us/cli/azure/create-an-azure-service-principal-azure-cli">Azure CLI</a> or with <a href="https://docs.microsoft.com/en-us/powershell/azure/create-azure-service-principal-azureps">Powershell</a>, ensuring that you keep track of the <code>NAME</code>, <code>ID</code> and <code>PASSWORD/SECRET</code> for the service principal, as these will be needed later.</p>
<h2 id="setup-terraform-with-python">Setup Terraform with Python<a class="headerlink" href="#setup-terraform-with-python" title="Permanent link">¶</a></h2>
<p><code>Terraform</code> uses a backend to keep track of the infrastructure state.
We keep the backend in <code>Azure</code> storage so that everyone has a synchronised version of the state.</p>
<details>
<summary> You can download the `tfstate` file with `az` though you won't need it.</summary>
<div class="codehilite"><pre><span></span><code><span class="nb">cd</span> terraform
az storage blob download -c terraformbackend -f terraform.tfstate -n terraform.tfstate --account-name terraformstorage924roouq --auth-mode key
</code></pre></div>
</details>
<p>To enable this, we have to create an initial <code>Terraform</code> configuration by running (from the root directory):</p>
<div class="codehilite"><pre><span></span><code>python cleanair_setup/initialise_terraform.py -i <span class="nv">$AWS_KEY_ID</span> -k <span class="nv">$AWS_KEY</span> -n <span class="nv">$SERVICE_PRINCIPAL_NAME</span> -s <span class="nv">$SERVICE_PRINCIPAL_ID</span> -p <span class="nv">$SERVICE_PRINCIPAL_PASSWORD</span>
</code></pre></div>
<p>Where <code>AWS_KEY_ID</code> and <code>AWS_KEY</code> are the secure key information needed to access TfL's SCOOT data on Amazon Web Services.</p>
<div class="codehilite"><pre><span></span><code><span class="nv">AWS_KEY</span><span class="o">=</span><span class="k">$(</span>az keyvault secret show --vault-name terraform-configuration --name scoot-aws-key -o tsv --query value<span class="k">)</span>
<span class="nv">AWS_KEY_ID</span><span class="o">=</span><span class="k">$(</span>az keyvault secret show --vault-name terraform-configuration --name scoot-aws-key-id -o tsv --query value<span class="k">)</span>
</code></pre></div>
<p>And <code>SERVICE_PRINCIPAL</code>'s  <code>NAME</code>, <code>ID</code> and <code>PASSWORD</code> are also available in the <code>terraform-configuration</code> keyvault.</p>
<div class="codehilite"><pre><span></span><code><span class="nv">SERVICE_PRINCIPAL_NAME</span><span class="o">=</span><span class="k">$(</span>az keyvault secret show --vault-name terraform-configuration --name azure-service-principal-name -o tsv --query value<span class="k">)</span>
<span class="nv">SERVICE_PRINCIPAL_ID</span><span class="o">=</span><span class="k">$(</span>az keyvault secret show --vault-name terraform-configuration --name azure-service-principal-id -o tsv --query value<span class="k">)</span>
<span class="nv">SERVICE_PRINCIPAL_PASSWORD</span><span class="o">=</span><span class="k">$(</span>az keyvault secret show --vault-name terraform-configuration --name azure-service-principal-password -o tsv --query value<span class="k">)</span>
</code></pre></div>
<p>This will only need to be run once (by anyone), but it's not a problem if you run it multiple times.</p>
<h2 id="building-the-clean-air-infrastructure-with-terraform">Building the Clean Air infrastructure with Terraform<a class="headerlink" href="#building-the-clean-air-infrastructure-with-terraform" title="Permanent link">¶</a></h2>
<p>To build the <code>Terraform</code> infrastructure go to the <code>terraform</code> directory</p>
<div class="codehilite"><pre><span></span><code><span class="nb">cd</span> terraform
</code></pre></div>
<p>and run:</p>
<div class="codehilite"><pre><span></span><code>terraform init
</code></pre></div>
<p>If you want to, you can look at the <code>backend_config.tf</code> file, which should contain various details of your <code>Azure</code> subscription.
<strong>NB. It is important that this file is in <code>.gitignore</code> . Do not push this file to the remote repository</strong></p>
<p>Then run:</p>
<div class="codehilite"><pre><span></span><code>terraform plan
</code></pre></div>
<p>which creates an execution plan. Check this matches your expectations. If you are happy then run:</p>
<div class="codehilite"><pre><span></span><code>terraform apply
</code></pre></div>
<p>to set up the Clean Air infrastructure on <code>Azure</code> using <code>Terraform</code>. You should be able to see this on the <code>Azure</code> portal.</p>
<h2 id="creating-a-record-for-cleanair-api-do-this-before-running-azure-pipelines">Creating A Record for cleanair API (DO THIS BEFORE RUNNING AZURE PIPELINES)<a class="headerlink" href="#creating-a-record-for-cleanair-api-do-this-before-running-azure-pipelines" title="Permanent link">¶</a></h2>
<p>Terraform created a DNS Zone in the kubernetes cluster resource group (<code>RG_CLEANAIR_KUBERNETES_CLUSTER</code>). Navigate to the DNS Zone on the Azure portal and copy the four nameservers in the “NS” record. Send the nameserver to Turing IT Services. Ask them to add the subdomain’s DNS record as an NS record for <code>urbanair</code> in the <code>turing.ac.uk</code> DNS zone record.</p>
<ol>
<li>When viewing the DNS zone on the Azure Portal, click <code>+ Record set</code></li>
<li>In the Name field, enter <code>urbanair</code>.</li>
<li>Set Alias record set to “Yes” and this will bring up some new options.</li>
<li>We can now set up Azure pipelines. Once the cleanair api has been deployed on kubernetes you can update the alias record to point to the ip address of the cleanair-api on the cluster.</li>
</ol>
<h2 id="initialising-the-input-databases">Initialising the input databases<a class="headerlink" href="#initialising-the-input-databases" title="Permanent link">¶</a></h2>
<p>Terraform will now have created a number of databases. We need to add the datasets to the database.
This is done using Docker images from the Azure container registry.
You will need the username, password and server name for the Azure container registry.
All of these will be stored as secrets in the <code>RG_CLEANAIR_INFRASTRUCTURE &gt; cleanair-secrets</code> Azure KeyVault.</p>
<!-- ## Using Travis (old)
These Docker images are built by Travis whenever commits are made to the GitHub repository.
Add `ACR_PASSWORD`, `ACR_SERVER` and `ACR_USERNAME` as Travis secrets.

To run the next steps we need to ensure that Travis runs a build in order to add the Docker images to the Azure container registry created by Terraform.
Either push to the GitHub repository, or rerun the last build by going to https://travis-ci.com/alan-turing-institute/clean-air-infrastructure/ and clicking on the `Restart build` button.
This will build all of the Docker images and add them to the registry. -->
<h2 id="setting-up-azure-pipelines">Setting up Azure pipelines<a class="headerlink" href="#setting-up-azure-pipelines" title="Permanent link">¶</a></h2>
<p>These Docker images are built by an Azure pipeline whenever commits are made to the master branch of the GitHub repository.
Ensure that you have configured Azure pipelines to <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/get-started/pipelines-get-started">use this GitHub repository</a>.
You will need to add Service Connections to GitHub and to Azure (the Azure one should be called <code>cleanair-scn</code>).
Currently a pipeline is set up <a href="https://dev.azure.com/alan-turing-institute/clean-air-infrastructure/_build">here</a>.</p>
<p>To run the next steps we need to ensure that this pipeline runs a build in order to add the Docker images to the Azure container registry created by Terraform.
Either push to the GitHub repository, or rerun the last build by going to <a href="https://dev.azure.com/alan-turing-institute/clean-air-infrastructure/_build">the Azure pipeline page</a> and clicking <code>Run pipeline</code> on the right-hand context menu.
This will build all of the Docker images and add them to the registry.</p>
<p>Now go to Azure and update the A-record to point to the ip address of the cleanair-api on the cluster.</p>
<h2 id="add-static-datasets">Add static datasets<a class="headerlink" href="#add-static-datasets" title="Permanent link">¶</a></h2>
<p>To add static datasets follow the <a href="#static-data-insert">Static data insert</a> instructions but use the production database credentials</p>
<h2 id="adding-live-datasets">Adding live datasets<a class="headerlink" href="#adding-live-datasets" title="Permanent link">¶</a></h2>
<p>The live datasets (like LAQN or AQE) are populated using regular jobs that create an Azure container instance and add the most recent data to the database.
These are run automatically through Kubernetes and the Azure pipeline above is used to keep track of which version of the code to use.</p>
<h2 id="kubernetes-deployment-with-gpu-support">Kubernetes deployment with GPU support<a class="headerlink" href="#kubernetes-deployment-with-gpu-support" title="Permanent link">¶</a></h2>
<p>The <a href="#setting-up-azure-pipelines">azure pipeline</a> will deploy the cleanair helm chart to the azure kubernetes cluster we deployed with terraform. If you deployed GPU enabled machines on Azure (current default in the terraform script) then you need to install the nvidia device plugin daemonset. The manifest for this is <a href="https://docs.microsoft.com/en-us/azure/aks/gpu-cluster">adapted from the Azure docs</a>. However, as our GPU machines have <a href="https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/#:~:text=Taints%20are%20the%20opposite%20%E2%80%93%20they,not%20scheduled%20onto%20inappropriate%20nodes.">taints</a> applied we have to add tolerations to the manifest, otherwise the nodes will block the daemonset. To install the custom manifest run,</p>
<div class="codehilite"><pre><span></span><code>kubectl apply -f kubernetes/gpu_resources/nvidia-device-plugin-ds.yaml
</code></pre></div>
<!-- 
## Configure certificates

https://cert-manager.io/docs/tutorials/acme/ingress/

## Uninstalling a failed helm install (warning - this will uninstall everything from the cleanair namespace on the cluster)

If the first helm install fails you may need to manually remove certmanager resources from the cluster with



<div class="codehilite"><pre><span></span><code>helm uninstall cleanair --namespace cleanair
</code></pre></div>




<div class="codehilite"><pre><span></span><code>kubectl get -n cleanair crd
kubectl delete -n cert-manager crd --all
kubectl delete namespaces cleanair
</code></pre></div>



Cluster roles may not be removed. Remove them with:

<div class="codehilite"><pre><span></span><code>kubectl get clusterrole  <span class="p">|</span> grep <span class="s1">&#39;cert-manager&#39;</span><span class="p">|</span>awk <span class="s1">&#39;{print $1}&#39;</span><span class="p">|</span> xargs kubectl delete clusterrole
kubectl get role --namespace kube-system  <span class="p">|</span> grep <span class="s1">&#39;cert-manager&#39;</span><span class="p">|</span>awk <span class="s1">&#39;{print $1}&#39;</span><span class="p">|</span> xargs kubectl delete role --namespace kube-system
kubectl get clusterrolebindings <span class="p">|</span> grep <span class="s1">&#39;cert-manager&#39;</span><span class="p">|</span>awk <span class="s1">&#39;{print $1}&#39;</span><span class="p">|</span>xargs kubectl delete clusterrolebindings
kubectl get mutatingwebhookconfigurations <span class="p">|</span> grep <span class="s1">&#39;cert-manager&#39;</span><span class="p">|</span>awk <span class="s1">&#39;{print $1}&#39;</span><span class="p">|</span>xargs kubectl delete mutatingwebhookconfigurations
kubectl get validatingwebhookconfigurations  <span class="p">|</span> grep <span class="s1">&#39;cert-manager&#39;</span><span class="p">|</span>awk <span class="s1">&#39;{print $1}&#39;</span><span class="p">|</span>xargs kubectl delete validatingwebhookconfigurations
kubectl get rolebindings --namespace kube-system <span class="p">|</span> grep <span class="s1">&#39;cert-manager&#39;</span><span class="p">|</span>awk <span class="s1">&#39;{print $1}&#39;</span><span class="p">|</span>xargs kubectl delete rolebindings --namespace kube-system
kubectl get clusterrole  <span class="p">|</span> grep <span class="s1">&#39;nginx&#39;</span><span class="p">|</span>awk <span class="s1">&#39;{print $1}&#39;</span><span class="p">|</span> xargs kubectl delete clusterrole
kubectl get clusterrolebindings <span class="p">|</span> grep <span class="s1">&#39;nginx&#39;</span><span class="p">|</span>awk <span class="s1">&#39;{print $1}&#39;</span><span class="p">|</span>xargs kubectl delete clusterrolebindings
</code></pre></div>



If helm wont install the chart after this check all api services are working:


<div class="codehilite"><pre><span></span><code>kubectl get apiservice
</code></pre></div>



Deleteing the failed api service may resolve this issue:


<div class="codehilite"><pre><span></span><code>kubectl delete apiservice v1beta1.metrics.k8s.io
</code></pre></div>




Follow theses instructions https://cert-manager.io/docs/tutorials/acme/ingress/ -->
<!-- We tell this job which version of the container to run by using GitHub webhooks which keep track of changes to the master branch.

### Setting up webhooks in the GitHub repository
- Run `python cleanair_setup/get_github_keys.py` to get the SSH keys and webhook settings for each of the relevant servers
- In GitHub go to `clean-air-infrastructure > Settings > Deploy keys` and click on `Add deploy key`
- Paste the key into `Key` and give it a memorable title (like `laqn-cleanair`)

### Enable webhooks in GitHub
- In GitHub go to `clean-air-infrastructure > Settings > Webhooks` and click on `Add webhook`
- Set the `Payload URL` to the value given by `get_github_keys.py`
- Set the `Content type` to `application/json` (not required but preferred)
- Select `Let me select individual events` and tick `Pull requests` only -->
<h2 id="removing-terraform-infrastructure">Removing Terraform infrastructure<a class="headerlink" href="#removing-terraform-infrastructure" title="Permanent link">¶</a></h2>
<p>To destroy all the resources created by <code>Terraform</code> run:</p>
<div class="codehilite"><pre><span></span><code>terraform destroy
</code></pre></div>
<p>You can check everything was removed on the Azure portal.
Then login to TravisCI and delete the Azure Container repo environment variables.</p>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-nav">
<nav aria-label="Footer" class="md-footer-nav__inner md-grid">
<a class="md-footer-nav__link md-footer-nav__link--prev" href="../researcher-guide/" rel="prev" title="Researcher guide">
<div class="md-footer-nav__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</div>
<div class="md-footer-nav__title">
<div class="md-ellipsis">
<span class="md-footer-nav__direction">
                  Previous
                </span>
                Researcher guide
              </div>
</div>
</a>
<a class="md-footer-nav__link md-footer-nav__link--next" href="../API/cleanair/dashboard/" rel="next" title="Dashboard">
<div class="md-footer-nav__title">
<div class="md-ellipsis">
<span class="md-footer-nav__direction">
                  Next
                </span>
                Dashboard
              </div>
</div>
<div class="md-footer-nav__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"></path></svg>
</div>
</a>
</nav>
</div>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
<div class="md-footer-copyright__highlight">
            Copyright © 2019-2020 Alan Turing Institute
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
          Material for MkDocs
        </a>
</div>
<div class="md-footer-social">
<a class="md-footer-social__link" href="https://github.com/alan-turing-institute/clean-air-infrastructure" rel="noopener" target="_blank" title="github.com">
<svg viewbox="0 0 480 512" xmlns="http://www.w3.org/2000/svg"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"></path></svg>
</a>
<a class="md-footer-social__link" href="https://www.turing.ac.uk/research/research-projects/london-air-quality" rel="noopener" target="_blank" title="www.turing.ac.uk">
<svg viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg>
</a>
</div>
</div>
</div>
</footer>
</div>
<script src="../assets/javascripts/vendor.d710d30a.min.js"></script>
<script src="../assets/javascripts/bundle.a14cc5fd.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
<script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.7a2ea5ba.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
</body>
</html>