
{{- $chart_name := .Chart.Name }}
{{- $chart_version := .Chart.Version | replace "+" "_" }}
{{- $release_name := .Release.Name }}
{{- $tag := .Values.imageTag }}
{{- $issueType := .Values.letsencryptType }}
{{ if .Values.ingressRules}}
---
apiVersion: networking.k8s.io/v1beta1
kind: Ingress
metadata:
  name: name-virtual-host-ingress
  annotations:
    kubernetes.io/ingress.class: "nginx"
    cert-manager.io/issuer: "letsencrypt-{{ $issueType }}"
    nginx.ingress.kubernetes.io/gzip-types: application/atom+xml application/javascript application/x-javascript application/json application/rss+xml application/vnd.ms-fontobject application/x-font-ttf application/x-web-app-manifest+json application/xhtml+xml application/xml font/opentype image/svg+xml image/x-icon text/css text/plain text/x-component text/csv
    {{- if $.Values.whitelistSourceRange}}
    nginx.ingress.kubernetes.io/whitelist-source-range: {{ $.Values.whitelistSourceRange }}
    {{ end }}
spec:
  tls:
  - hosts:
    {{- range $tls := .Values.tls }}
    - {{ $tls.host }}
    secretName: {{ $tls.secretName }}
    {{- end }}
  rules:
  {{- range $rule := .Values.ingressRules }}
  - host: {{ $rule.host }}
    http:
      paths:
      {{- range $path := $rule.paths }}
      - path: {{ $path.path }}
        backend:
          serviceName: "{{ $release_name }}-{{ $path.serviceName }}"
          servicePort: {{ $path.servicePort }}
      {{- end }}
  {{- end }}
{{ end }}